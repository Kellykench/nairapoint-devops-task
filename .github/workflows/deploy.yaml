name: Deploy Python App to DOKS

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Environment variables matching your resources
env:
  REGISTRY_NAME: kelly-app-registry-temp
  IMAGE_NAME: my-python-app
  TAG: latest 
  CLUSTER_ID: e4cf8671-0749-4ea0-a812-f8777b52bfd7
  DEPLOYMENT_FILE: deployment.yaml

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Build and Push to DOCR
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DigitalOcean Container Registry
        # Uses the DIGITALOCEAN_ACCESS_TOKEN secret for authentication
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          password: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: registry.digitalocean.com/${{ env.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}
          file: app-source/Dockerfile

      # 2. Deploy to Kubernetes
      - name: Set up Kubeconfig and Install Kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure Kubeconfig File
        # Writes the KUBE_CONFIG_YAML secret content to a file for kubectl to use
        run: |
          echo "${{ secrets.KUBE_CONFIG_YAML }}" > kubeconfig.yaml
          export KUBECONFIG=kubeconfig.yaml

      - name: Recreate DOCR Image Pull Secret
        # This uses the doctl action to ensure the k8s secret is up-to-date
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        run: |
          # The doctl command generates the docr-secret YAML and pipes it to kubectl for application
          doctl registry kubernetes-manifest ${{ env.REGISTRY_NAME }} --name docr-secret | kubectl apply -f -
          
      - name: Deploy to Kubernetes
        # Applies the deployment manifest to trigger a rolling update
        run: |
          kubectl apply -f ${{ env.DEPLOYMENT_FILE }}